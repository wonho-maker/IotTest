<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="" />
<meta name="author" content="" />

<!-- jQuery -->
<script
	src="/js/jquery.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- high chart -->
<script src="/js/highcharts.js"></script>

<script th:inline="javascript">
/*<![CDATA[*/
	function getCurrentId()
    	{
			var currentUrl = window.location.pathname;
    		
    		var currentId = currentUrl.split("chart");
    		currentId = currentId[currentId.length - 1];
    		
    		currentId = "/api"+currentId;
    		
    		var apiKey = /*[[${apiKey}]]*/ null;
    		
    		if(apiKey != null) {
    			currentId += "?key=" + apiKey;
    		}
    		
    		//currentId = "http://localhost/api/devices/1";
    		//console.log(currentId);
			return currentId;
    	}           
           
/*]]>*/


</script>

<script>
    	function getChartDate(date)
		{
    		var myOffset = new Date().getTimezoneOffset();
    		
			return Date.UTC(date.substring(0,4), date.substring(5,7)-1, date.substring(8,10), date.substring(11,13), 
					date.substring(14,16), date.substring(17,19)) - (myOffset * 60000);
		}
    	
   		function getAvailableFields(jsonData){
    		
    		var availableField = new Array(5);
    		
    		if(jsonData[0].dataName1 != null)
    			availableField[0] = jsonData[0].dataName1;
    		if(jsonData[0].dataName2 != null)
    			availableField[1] = jsonData[0].dataName2;
    		if(jsonData[0].dataName3 != null)
    			availableField[2] = jsonData[0].dataName3;
    		if(jsonData[0].dataName4 != null)
    			availableField[3] = jsonData[0].dataName4;
    		if(jsonData[0].dataName5 != null)
    			availableField[4] = jsonData[0].dataName5;
    		
    		return availableField;
    	}
    	
    	function getAvailableFieldsLength(availableFields)
    	{
    		var length = 0;
    		$.each(availableFields, function(i, value){
    			if(value == 1)
    				length++;
    		});
    		
    		return length;
    	}
    	
    	function getValidFieldsData(fields)
    	{
    		var validFieldsData = [];
    		
			if(fields.dataValue1 != null) {
				validFieldsData.push(fields.dataValue1);
			}
			
			if(fields.dataValue2 != null) {
				validFieldsData.push(fields.dataValue2);
			}
			
			if(fields.dataValue3 != null) {
				validFieldsData.push(fields.dataValue3);
			}
			
			if(fields.dataValue4 != null) {
				validFieldsData.push(fields.dataValue4);
			}
			
			if(fields.dataValue5 != null) {
				validFieldsData.push(fields.dataValue5);
			}
			
			return validFieldsData;
    	}
    	
    	function allocateChartArray(length)
    	{
    		var chartDataArray = new Array(length);
    		
    		console.log(chartDataArray.length);
    		
    		$.each(chartDataArray, function(i, value) {
    			chartDataArray[i] = [];
    		});
    			
    		
    		return chartDataArray;
    	}
    	
    </script>

<script>
 
	$(document).ready(function() 
	{
		Highcharts.setOptions({
			chart : {
				backgroundColor : {
					linearGradient : [ 0, 0, 500, 500 ],
					stops : [ [ 0, 'rgb(255, 255, 255)' ],
							[ 1, 'rgb(240, 240, 255)' ] ]
				},
				//borderWidth: 2,
				plotBackgroundColor : 'rgba(255, 255, 255, .9)',
				plotShadow : true,
				plotBorderWidth : 1
			}
		});
		
		var options = {
		        chart: {
		            renderTo: 'container'
		            
		        },
		        title: {
		        	text: ' '
		        },
		        subtitle:{
		        	text: ' '
		        },
		        xAxis: {
		        	type: 'datetime'
		        },
		        series: [{
		        	//pointInterval : 3600 * 1000
		        	name : 'empty'
		        }, {
		        	name : 'empty'
		        }, {
		        	name : 'empty'
		        }, {
		        	name : 'empty'
		        }, {
		        	name : 'empty'
		        }],
		        credits : {
					text : 'Iot Test',
					//href: 'http://'
					style : {
						color : '#D62020'
					}
		        }
		    };
			
			
		    $.getJSON(getCurrentId(), function(jsonData) {
		        
		    	if(jsonData[0].id == null) {
		    		$('#subtitle').append(jsonData[0].deviceName);
		    		//console.log(jsonData[0].deviceName);
		    		//console.log("ok");
		    		return;
		    	}
		    		
		    	
		    	var availableFields = getAvailableFields(jsonData);
		    	
		        var chartDataArray = allocateChartArray(availableFields.length);
		        
		        $.each(jsonData, function(i, data)
		        {
		        	
		        	var chartData = [];
		        	$.each(data.dataFields, function(k, field)
		        	{
		        		
		        		var validData = getValidFieldsData(field);
		        		 
		        		$.each(validData, function(m, vData) {
		        			var point = new Highcharts.Point();
		        			
				        	point.x = getChartDate(field.updateTime);
					        point.y = parseFloat(vData);
		        			
					        chartDataArray[m].push(point);
					        
		        		});
						
		        	});
		        	
			    });
		        
		      //set series and series's name
		        var series = [];
		        
		        $.each(availableFields, function(i, value){
		        	if(value != null) {
		        		var seriesTemp = new Highcharts.Series();
		        		seriesTemp.name = value;
		        		series.push(seriesTemp);
		        	}
		        });
		        
		        options.series = series;
				
		        //set data to series
		        var k = 0;
		        
		        $.each(availableFields, function(j, aFields){
		        	if(aFields != null) {
		        		options.series[k].data = chartDataArray[k];
			        	options.series[k].name = aFields;
			        	k++;
		        	}
		        	else {
		        		
		        	}
		        	
		        });
		        
		        //set chart title
		    	options.title.text = jsonData[0].deviceName;;
				
		    	//apply chart
		        var chart = new Highcharts.Chart(options);
		    });

	});
				
</script>


<title>Chart</title>
</head>
<body>
	<div id="subtitle"></div>
	<div id="container" style="width: 100%; height: 330px;"></div>

	
	
</body>
</html>